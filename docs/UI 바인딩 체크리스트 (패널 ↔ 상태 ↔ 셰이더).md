# 🎛️ UI 바인딩 체크리스트 (패널 ↔ 상태 ↔ 셰이더)

## A. 컨트롤 → 상태(State) 매핑

| UI 컨트롤                | 대상 속성/Uniform                                     | 타입/범위 | 업데이트 타이밍 | 유효성/클램프        | 메모                                     |
| ------------------------ | ----------------------------------------------------- | --------- | --------------- | -------------------- | ---------------------------------------- |
| 배경 컬러 팔레트         | `bgColor.srgb` → `u_bgColorLinear`                    | sRGB 0–1  | `input` 즉시    | 0–1 클램프, NaN 금지 | CPU에서 sRGB→Linear 변환 후 uniform 적용 |
| 모양 라디오(원/사각)     | `selectedLight.type` → `u_lightType[i]`               | enum      | 변경 시 즉시    | -                    | 타입 전환 시 반경/사이즈 동기화          |
| 밝기(HDR) 슬라이더       | `selectedLight.intensity` → `u_lightIntensity[i]`     | 0–2000    | `input` 즉시    | \[0, 2000]           | 300\~600 기본 권장                       |
| 반경 슬라이더(원형)      | `selectedLight.radius` → `u_lightRadius[i]`           | px        | `input` 즉시    | \[1, 4000]           | 최소 1 보장(0 방지)                      |
| 가로/세로 슬라이더(사각) | `selectedLight.rectSize.{w,h}` → `u_lightRectSize[i]` | px        | `input` 즉시    | \[1, 4096]           | w/h 각각 클램프                          |
| Softness 슬라이더        | `selectedLight.softness` → `u_lightSoftness[i]`       | 0–1       | `input` 즉시    | \[0, 1]              | 0=하드, 1=소프트                         |
| Hotspot 슬라이더         | `selectedLight.hotspot` → `u_lightHotspot[i]`         | 0–1       | `input` 즉시    | \[0, 1]              | `hotspot ≤ 1` 유지                       |
| Falloff 슬라이더         | `selectedLight.falloffK` → `u_lightFalloffK[i]`       | 0.1–8     | `input` 즉시    | \[0.1, 8]            | 1/r² 계수                                |
| 색상 팔레트(조명)        | `selectedLight.colorSrgb` → `u_lightColorLinear[i]`   | sRGB 0–1  | `input` 즉시    | 0–1                  | CPU에서 선형 변환 캐시                   |
| 블렌딩 강도 슬라이더     | `blendStrength` → `u_blendStrength`                   | 0–2       | `input` 즉시    | \[0, 2]              | 다중 조명 중첩 조절                      |
| 노출 슬라이더            | `exposure` → `u_exposure`                             | 0.1–5     | `input` 즉시    | \[0.1, 5]            | 톤매핑 전역 스케일                       |
| 패널 토글 버튼/키(P)     | `ui.panelVisible`                                     | bool      | 클릭/키다운     | -                    | 숨김 시 선택 해제(trigger)               |
| 삭제 버튼                | 선택 조명 삭제                                        | -         | 클릭            | 선택 존재 여부 확인  | 삭제 후 패널 비활성화                    |
| 더블클릭                 | 클릭 대상 조명 삭제                                   | -         | 더블클릭        | hit test 필요        | 패널/선택 상태 초기화                    |

> **즉시 반영 원칙**: 슬라이더·팔레트는 `input` 이벤트마다 상태 업데이트 → 렌더 직전 한 번에 uniform 업로드(배치)
> **선형 변환 캐시**: `colorSrgb` 변경 시에만 `colorLinear` 재계산해 성능 절약

---

## B. 선택/상태 전파 흐름

1. **조명 클릭** → hit test 성공 → `selectedId` 변경
2. `selectedId` 변경 시 패널 컨트롤 값 **역바인딩**(선택 조명 속성으로 UI 값 채움)
3. 패널 컨트롤 변경 → 선택 조명 속성 업데이트 → “렌더 사이클 시작 시” uniform 일괄 업로드
4. **패널 토글로 숨김** → `selectedId = null`로 즉시 해제, 패널 컨트롤 disabled 처리
5. **삭제**(버튼/더블클릭) → 상태 배열에서 제거 → `selectedId = null` → 다음 프레임에 uniform 압축 업로드

---

## C. 검증/에러 처리 규칙

- 모든 수치 입력은 **클램프** + **NaN 방지** (미지정/빈 문자열은 마지막 유효 값 유지)
- 사각형 전환 시 `rectSize`가 비정상(0/NaN)이면 `radius` or 기본값으로 대체
- `u_numLights`는 실제 업로드 수와 항상 일치 (삭제 후 압축 실패 방지)
- 팔레트 색상 미선택 시 기본값 유지(흑/회 선택 버튼 우선)

---

## D. 리렌더/업로드 최적화

- 매 프레임: **활성 조명 배열 압축** → `u_*[i]`에 연속 업로드
- **변경 없으면 업로드 생략**(dirty flag):

  - per-light dirty: 해당 인덱스만 갱신
  - global dirty: bg, exposure, blendStrength 등

- UI 슬라이더는 **체인지 스로틀(예: 16ms)** 로 uniform 업로드 빈도 제한(시각상 실시간 유지)

---

# 🚀 U_MAX_LIGHTS 및 성능 표준값

## A. 권장 기본값 (목표 60 FPS)

| 디바이스 클래스          | 해상도 타겟 | `U_MAX_LIGHTS` | 실사용 권장(동시) | 비고                        |
| ------------------------ | ----------: | -------------: | ----------------: | --------------------------- |
| 모바일 저가(3\~5년)      |    1280×720 |             24 |              8–12 | 고소프트니스/대반경 시 감소 |
| 모바일 중급(최근 2\~3년) |    1600×900 |             32 |             12–20 | 일반 스튜디오 테스트 권장   |
| 태블릿/아이패드급        |   1920×1080 |             48 |             16–24 | 펜 입력 시에도 OK           |
| 노트북 내장그래픽        |   1920×1080 |             64 |             24–32 | WebGL1에서도 안정           |
| 데스크톱 dGPU            |   2560×1440 |             96 |             32–48 | 후처리(블룸) 여유           |

> `U_MAX_LIGHTS`는 **uniform 배열 길이**이며, **동시 활성 조명 개수**(`u_numLights`)는 그 이하로 유지.
> 실제 프레임은 **라이트 수 × 소프트니스/반경/해상도**에 크게 영향.

---

## B. 프레임 예산 가이드

- 목표: **16.6ms(60fps)**

  - **셰이더 패스**: 4–9ms (라이트 16–32개 기준, FHD)
  - **UI/JS 로직**: 1–3ms
  - **업로드/상태 갱신**: 0.5–1.5ms

- **경고 임계치**: 프레임 20ms↑ 지속 시 **자동 품질 다운스케일** 트리거(아래 전략)

---

## C. 사실상 성능 스위치(자동 품질 변화)

1. **동적 해상도 스케일링**: 내부 렌더 타겟 해상도를 1.0 → 0.75 → 0.5 단계로 축소
2. **라이트 수 제한**: `u_numLights` 클램프 (가장 최근/선택 우선, 오래된/어두운 라이트부터 비활성)
3. **Softness 상한**: 0.9 → 0.6으로 자동 제한(페널브라 계산 비용/밝은 영역 확산 감소)
4. **업데이트 빈도 축소**: 슬라이더 입력시 uniform 업로드 스로틀 16ms → 33ms
5. **톤매핑 경량화**: 필요 시 `exponential` 유지, filmic 등 무거운 곡선 사용 금지

---

## D. WebGL 한계 및 확장 포인트

- **Uniform 배열 상한**: 드라이버에 따라 작음 → 64\~128 요소 근처에서 제한

  - 한계 돌파 옵션(확장 단계): **Uniform Texture/SSBO** 대신 **텍스처(look-up) 패킹**

    - 라이트 속성을 RGBA 텍스처 행/열에 패킹, 셰이더에서 `texelFetch`로 읽기

- **분기 최소화**: 타입 분기는 `step`/`mix`로 처리, 루프 내 `if` 억제
- **정밀도**: `highp` 고수. 모바일에서 `mediump`는 falloff/톤매핑 밴딩 위험

---

# 🧪 통합 테스트 체크리스트 (실사용 기준)

### 기능 동작

- [ ] 패널 토글 시 즉시 선택 해제, 패널 disabled
- [ ] 삭제 버튼/더블클릭 삭제 모두 정상, 삭제 후 `u_numLights` 정확
- [ ] 모양 전환(원↔사각) 후 슬라이더 맵핑 일관(반경↔가로/세로)
- [ ] 밝기 0–2000 구간에서 노출/블렌딩과 상호작용 자연스러움

### 렌더 품질

- [ ] 핫스폿 조절 시 중심 과광 영역 변화 명확
- [ ] Softness 0/1에서 경계 품질 극명
- [ ] Falloff 계수 변화가 거리 감쇠에 일관되게 반영
- [ ] 다색 조명 중첩 시 색 왜곡/밴딩 없음(sRGB/Linear 처리 OK)

### 성능/안정성

- [ ] 모바일(중급)에서 12\~20라이트, 60fps 근접 유지
- [ ] 20ms↑ 지속 시 품질 스위치(해상도/라이트 제한) 동작
- [ ] 빠른 슬라이더 드래그 시에도 프레임 드랍 없도록 업로드 스로틀 적용
- [ ] 리사이즈/회전(모바일 가로세로) 후 좌표/사이즈 스케일 일관

---

# 📌 운영 팁 (현장 테스트용)

- **초기 프리셋**: 5600K 소프트박스(사각 800×600, softness 0.5, hotspot 0.2, intensity 450) + 3200K 키라이트(원 반경 220, intensity 600) 두 개로 시작 → 블렌딩 1.0, 노출 1.2
- **현장 색관리**: 배경과 라이트 색상 모두 **Linear 처리 후 톤매핑** 유지(스크린샷 비교 시 일관성 큼)
- **밝기 튜닝 순서**: 먼저 **노출**로 전역 톤을 잡고 → 각 라이트 **intensity**로 미세 조정 → 마지막에 **블렌딩 강도**

---
