# 📑 기능명세서 (광원 크기 & 페더 분리 반영)

## 📂 프로젝트 구조

```
your-light-simulator/
│
├── index.html      # p5.js, UI 패널 포함
├── main.js         # 캔버스 렌더링, 이벤트 핸들링, 조명 배열 관리
├── shader.frag     # 프래그먼트 쉐이더 (핫스폿/페더/감쇠 연산)
├── shader.vert     # 버텍스 쉐이더 (fullscreen quad)
├── ui.js           # 패널 UI 이벤트, 단축키 처리
├── styles.css      # 패널 및 캔버스 레이아웃 스타일
└── assets/         # 아이콘, 프리셋 파일 등
```

---

## 🔢 개발 우선순위

1. **쉬운 기능**

   - 배경 색상 설정
   - 조명 삭제
   - 패널 토글 (숨김 시 선택 해제)

2. **핵심 기능**

   - 조명 생성 (클릭 기반)
   - 조명 선택/이동
   - 조명 속성 제어 (패널 UI: **크기·밝기·페더·색상**)
   - 여러 조명 동시 생성

3. **어려운 기능**

   - 빛 블렌딩 효과 (Additive Blending + 강도 조절)
   - 쉐이더 기반 라이트 렌더링 (**핫스폿+페더** 분리, inverse-square falloff)

---

## 🖥️ 기능별 명세

### 1. 배경 색상 설정 (쉬움)

- **UI 요소**: 팔레트(Color picker), 버튼(검정/회색)
- **렌더링**: 배경색을 linear 공간으로 변환 후 GPU에 전달
- **파일 위치**:

  - `index.html` → `<input type="color">`, 버튼
  - `ui.js` → 이벤트 핸들러
  - `main.js` → uniform `u_bgColorLinear` 업데이트

- **테스트 체크리스트**:

  - 초기값 검정
  - 회색 버튼 클릭 반영
  - 팔레트 선택 시 즉시 반영

---

### 2. 조명 생성 (클릭 기반) (핵심)

- **동작**: 캔버스 클릭 → 조명 생성
- **옵션**: 모양 선택 (원형/사각형)
- **파일 위치**:

  - `main.js` → `mousePressed()`에서 `lights[]` push

- **테스트 체크리스트**:

  - 클릭 시 라이트 생성
  - 원형/사각형 선택값 적용

---

### 3. 조명 선택/이동 (핵심)

- **동작**:

  - 클릭 → 선택 상태 진입
  - 드래그 → 이동

- **UI 반영**:

  - 선택 시 외곽선 또는 반투명 하이라이트
  - 패널 값 갱신

- **파일 위치**:

  - `main.js` → `mousePressed()` hit test, `mouseDragged()` 좌표 업데이트

- **테스트 체크리스트**:

  - 클릭 전환 정상
  - 이동 자연스럽게 반영

---

### 4. 조명 속성 제어 (패널 UI) (핵심)

- **UI 요소**:

  - **크기(Size)** 슬라이더 → 광원 본체(핫스폿 반경/사각형 본체)
  - **밝기(Intensity)** 슬라이더 → HDR 스케일 (0–2000)
  - **페더(Feather/Softness)** 슬라이더 → 가장자리 퍼짐 (0–1)
  - **색상(Color)** 팔레트 → sRGB → Linear 변환

- **파일 위치**:

  - `ui.js` → 슬라이더 이벤트
  - `main.js` → 선택 라이트 속성 업데이트
  - `shader.frag` → size vs feather 분리 적용

- **테스트 체크리스트**:

  - 크기와 페더 독립 조절 확인
  - 크기 변경 시 본체(핫스폿) 영역만 변경
  - 페더 변경 시 경계 퍼짐 폭만 변함
  - 밝기 확장 범위에서 고휘도 표현됨

---

### 5. 여러 조명 동시 생성 (핵심)

- **동작**:

  - 여러 번 클릭으로 라이트 누적 생성
  - 개별 선택/속성 조절 가능

- **파일 위치**:

  - `main.js` → `lights[]` 관리

- **테스트 체크리스트**:

  - 여러 라이트 생성 가능
  - 독립 속성 변경 가능

---

### 6. 조명 삭제 (쉬움)

- **동작**:

  - 패널 내 삭제 버튼
  - 더블클릭 제스처

- **파일 위치**:

  - `ui.js` → 버튼 핸들러
  - `main.js` → 더블클릭 판별 후 제거

- **테스트 체크리스트**:

  - 버튼으로 선택 라이트 제거
  - 더블클릭 시 해당 라이트 제거
  - 삭제 후 패널 초기화됨

---

### 7. 패널 토글 (쉬움)

- **동작**:

  - 단축키(`P`) 또는 버튼으로 표시/숨김
  - 숨김 시 선택 해제 처리

- **파일 위치**:

  - `ui.js` → 키 이벤트, 토글 버튼
  - `styles.css` → show/hide 전환

- **테스트 체크리스트**:

  - 토글 동작 정상
  - 숨김 시 자동 선택 해제
  - 다시 열면 비선택 상태 유지

---

### 8. 빛 블렌딩 효과 (어려움)

- **렌더링**:

  - Additive Blending (`blendMode(ADD)` or custom shader sum)
  - 패널 슬라이더로 `u_blendStrength` 제어

- **파일 위치**:

  - `main.js` + `shader.frag` 누적 연산

- **테스트 체크리스트**:

  - 중첩 시 자연스러운 합성
  - 강도 슬라이더 반영됨

---

### 9. 쉐이더 기반 라이트 렌더링 (어려움)

- **핵심**:

  - **크기(Size)** = 핫스폿 반경
  - **페더(Feather)** = 퍼짐 거리
  - 거리 감쇠 = inverse-square falloff

- **쉐이더 로직**:

  - r ≤ Size → 밝기 100%
  - Size < r < Size+Feather → `smoothstep` 기반 페더 감쇠
  - r ≥ Size+Feather → 0

- **파일 위치**:

  - `shader.frag` → 라이트 프로파일 구현

- **테스트 체크리스트**:

  - 크기만 조정 → 본체 크기 변화
  - 페더만 조정 → 퍼짐 폭 변화
  - 두 값 독립 제어 검증됨

---

## ✅ 최종 테스트 플로우

1. 실행 시 배경 검정 → 회색·팔레트 반영 확인
2. 클릭 시 라이트 생성 (원형/사각형)
3. 라이트 선택 및 이동 확인
4. 패널에서 크기·밝기·페더·색상 독립 조절 → 실시간 반영
5. 여러 라이트 생성 후 개별 속성 제어 확인
6. 삭제 버튼·더블클릭으로 제거 확인
7. 패널 토글(`P`) → 숨김/선택 해제 확인
8. 라이트 겹침 시 Additive Blending 효과 확인
9. 쉐이더 기반 렌더링에서 **핫스폿+페더** 구조 확인

---

👉 이번 업데이트 반영으로 “**크기(Size) vs 페더(Feather)**”를 분리 제어할 수 있게 되어, 실제 조명처럼 핫스폿과 가장자리 퍼짐을 독립 검증할 수 있습니다.

---

# 🎨 쉐이더 Uniform 설계 (크기 & 페더 분리 버전)

## 전역(Global) Uniform

| 이름              | 타입    | 설명                        |
| ----------------- | ------- | --------------------------- |
| `u_resolution`    | `vec2`  | 캔버스 크기(px)             |
| `u_bgColorLinear` | `vec3`  | 배경색 (Linear 공간)        |
| `u_exposure`      | `float` | 톤매핑 노출(0.1–5.0)        |
| `u_blendStrength` | `float` | Additive 블렌딩 전역 스케일 |
| `u_numLights`     | `int`   | 활성 조명 개수              |
| `u_colorSpace`    | `int`   | 0=Linear, 1=sRGB 입력       |

---

## 라이트 배열 Uniform

(속성별 배열 방식, WebGL1 호환)

| 이름                    | 타입    | 설명                                             |
| ----------------------- | ------- | ------------------------------------------------ |
| `u_lightType[i]`        | `int`   | 0=Circle, 1=Rect                                 |
| `u_lightPos[i]`         | `vec2`  | 중심 좌표(px)                                    |
| `u_lightColorLinear[i]` | `vec3`  | 조명 색 (Linear)                                 |
| `u_lightIntensity[i]`   | `float` | 밝기(HDR, 0–2000)                                |
| `u_lightSize[i]`        | `float` | **핫스폿 크기** (광원 본체 반경, px)             |
| `u_lightFeather[i]`     | `float` | **페더 크기** (핫스폿 외곽\~페널브라 끝까지, px) |
| `u_lightRectSize[i]`    | `vec2`  | 사각형 본체 크기(px)                             |
| `u_lightRotation[i]`    | `float` | 사각형 회전(rad)                                 |
| `u_lightFalloffK[i]`    | `float` | inverse-square 계수(0.1–8)                       |

---

# 🔬 조명 프로파일 연산

## 원형 라이트

```
r = distance(frag, u_lightPos[i]);

if (r <= Size)
   profile = 1.0;                        // 본체(핫스폿)
else if (r <= Size + Feather)
   profile = smoothstep(Size+Feather, Size, r);  // 페더 구간
else
   profile = 0.0;
```

- `Size = u_lightSize[i]`
- `Feather = u_lightFeather[i]`

---

## 사각형 라이트

1. 회전 보정:

```
p = rotate(frag - pos, -rotation);
```

2. Signed Distance Box:

```
q = abs(p) - 0.5 * u_lightRectSize[i];
dist = length(max(q, 0.0)) + min(max(q.x,q.y), 0.0);
```

3. 프로파일 적용 (원형과 동일):

```
if (dist <= Size) profile = 1.0;
else if (dist <= Size + Feather) profile = smoothstep(Size+Feather, Size, dist);
else profile = 0.0;
```

---

## 밝기 및 색상

```
baseFalloff = 1.0 / (1.0 + u_lightFalloffK[i] * (r*r));
intensity   = u_lightIntensity[i] * baseFalloff;
lightRGB    = u_lightColorLinear[i] * intensity * profile;
```

---

# 📌 패널 ↔ Uniform 매핑

| 패널 컨트롤     | Uniform 매핑            | 범위         | 초기값        |
| --------------- | ----------------------- | ------------ | ------------- |
| 크기(Size)      | `u_lightSize[i]`        | 10–1200 px   | 300           |
| 페더(Feather)   | `u_lightFeather[i]`     | 0–800 px     | 150           |
| 밝기(Intensity) | `u_lightIntensity[i]`   | 0–2000       | 400           |
| 색상(Color)     | `u_lightColorLinear[i]` | 0–1 (linear) | 흰색 or 5600K |
| Falloff         | `u_lightFalloffK[i]`    | 0.1–8        | 1.5           |
| 블렌딩 강도     | `u_blendStrength`       | 0–2          | 1.0           |
| 노출            | `u_exposure`            | 0.1–5        | 1.2           |

---

# 🧪 테스트 체크리스트 (Size vs Feather 분리)

- [ ] 크기(Size) 슬라이더만 변경 → 핫스폿 본체 영역이 확대/축소됨
- [ ] 페더(Feather) 슬라이더만 변경 → 퍼지는 가장자리 폭만 늘어나거나 줄어듦
- [ ] 둘 다 0 → 단단한 점광원(핫스폿만)
- [ ] Size=300, Feather=200 → 부드러운 페널브라 확인
- [ ] 다수 조명 겹침 시 Additive Blending으로 합성 자연스러움

---

👉 이렇게 업데이트하면, PRD에서 의도한 \*\*“크기(Size)=광원 본체” vs “페더(Feather)=가장자리 퍼짐”\*\*이 셰이더 레벨에서도 명확히 분리됩니다.
