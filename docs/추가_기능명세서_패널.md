# 📑 기능명세서 (패널 드래그/도킹 오버레이 반영)

## 📂 프로젝트 구조

```
your-light-simulator/
│
├── index.html      # p5.js 캔버스 + 오버레이 패널 마크업
├── main.js         # 캔버스 렌더링, 조명/선택 상태, 히트테스트/이동
├── ui.js           # 패널 드래그/도킹/토글, 패널 ↔ 상태 바인딩, 로컬 스토리지 복원
├── shader.vert     # fullscreen quad
├── shader.frag     # 라이트 프로파일(핫스폿/페더, inverse-square), 누적/톤매핑
├── styles.css      # 패널 레이아웃/스타일(z-index, pointer), 세이프 존
└── assets/         # (옵션) 아이콘/프리셋
```

---

## 🔢 개발 우선순위 (업데이트 반영)

1. **쉬움**

- 배경 색상 설정
- 조명 삭제
- **패널 토글(오버레이, 좌표 불변)**

2. **핵심**

- 조명 생성(클릭), 선택/이동
- **조명 속성 제어(패널: 크기/밝기/페더/색상)**
- 여러 조명 동시 생성

3. **보통**

- **오버레이 패널 드래그/도킹(좌/우 스냅, 화면 밖 제한, 위치 저장)**

4. **어려움**

- Additive 블렌딩(강도 조절)
- 쉐이더 기반 라이트 렌더링(핫스폿/페더 분리, inverse-square)

---

## 🖥️ 기능별 명세

### A. 패널 오버레이 & 토글 (MVP)

- **레이아웃**: `position: fixed; z-index` 최상위. 캔버스 위에 떠있음. 캔버스 크기/좌표계 **변경 없음**.
- **토글**: 단축키 `P` / 버튼. 숨김 시 **선택 해제 유지**(= 숨김할 때 deselect, 다시 켜도 비선택 상태).
- **접근성**: 토글 시 포커스가 캔버스/문서에 머물도록(포커스 트랩 금지). 키보드 탭 이동 정상 동작.

**파일 위치**

- `index.html`: 패널 컨테이너/헤더/본문 UI 마크업
- `styles.css`: 고정 오버레이, 그림자, 반투명 배경, 포인터 스타일
- `ui.js`: 토글 상태 저장(세션), 표시/숨김 전환, 선택 해제 트리거

**테스트**

- [ ] 토글해도 캔버스 크기/좌표 변동 없음
- [ ] 숨김 시 선택 해제, 표시 시 비선택 상태 유지
- [ ] 패널 위 컨트롤 포커스 후 키보드 입력 시 캔버스 제스처와 충돌 없음

---

### B. 패널 드래그/도킹(오버레이)

- **드래그 핸들**: **헤더 바만** 드래그 가능 (본문 컨트롤은 드래그 없음).
- **좌표 업데이트**: `transform: translate(x,y)`로 GPU 가속.
- **경계 제한**: 패널이 화면 밖으로 못 나가게 **좌/우/상/하** 클램프.
- **스냅(도킹)**: 좌/우 가장자리 **스냅 거리 40px** 내 접근 시, 해당 가장자리에 착붙도록 x를 정렬.
- **위치 저장/복원**: `localStorage.panelPos = { x, y, snapSide }` 저장. 다음 진입 시 복원.
- **세이프 존**: 상단 OS 바/노치 고려 **최소 마진 8\~16px** 유지. 회전/윈도 크기 변경 시 자동 재클램프.

**파일 위치**

- `ui.js`: pointerdown/move/up로 드래그, requestAnimationFrame 스로틀(≈16ms), 경계/스냅, 저장/복원
- `styles.css`: `.panel--dragging` 커서/선택금지, `.panel--docked-left/right` 상태별 그림자/간격

**테스트**

- [ ] 헤더 드래그로 자연스럽게 이동
- [ ] 화면 밖으로 절대 나가지 않음(모서리 클램프 동작)
- [ ] 좌/우 40px 내 접근 시 스냅
- [ ] 새로고침/재진입 시 위치 복원
- [ ] 모바일 노치/상단바 영역 겹치지 않음(최소 마진 유지)
- [ ] 드래그 중 CPU 사용량 과다 없음(스로틀 적용)

---

### C. 조명 생성/선택/이동 (핵심)

- **생성**: 캔버스 클릭 → 지정 모양(원/사각)으로 새 라이트 추가.
- **선택**: 히트테스트로 클릭 대상 선택, 패널에 값 반영.
- **이동**: 선택 상태에서 드래그로 위치 이동(패널 드래그와 충돌 없도록 패널 위 영역은 캔버스 이벤트 미전파).

**파일 위치**

- `main.js`: mousePressed/Dragged/Released, hit test, 상태 업데이트
- `styles.css`: 선택 라이트 하이라이트(가이드 라인/미세 외곽선)

**테스트**

- [ ] 생성/선택/이동 모두 자연스럽게 동작
- [ ] 패널 위에서 드래그해도 캔버스가 반응하지 않음(이벤트 캡처/중단)

---

### D. 조명 속성 제어 (패널)

- **컨트롤**:

  - **Size(핫스폿 본체)**: 원=반경, 사각=본체(핫스폿) 기준 길이
  - **Feather(페더/소프트니스)**: 본체 경계부터 외곽까지 퍼짐 폭(px)
  - **Intensity(HDR)**: 0–2000
  - **Color**: 팔레트(sRGB) → CPU에서 Linear 변환 캐시
  - 전역: **Blend Strength**, **Exposure**

- **비활성화 규칙**: 선택 없음 → 모든 컨트롤 disabled.

**파일 위치**

- `index.html`(컨트롤 마크업), `ui.js`(바인딩), `main.js`(상태 반영), `shader.frag`(프로파일 적용)

**테스트**

- [ ] Size만 변경 시 본체 크기만 변함
- [ ] Feather만 변경 시 퍼짐 폭만 변함
- [ ] 밝기 상향 시 과광/HDR 느낌, 노출/블렌딩과 상호작용 자연스러움

---

### E. 삭제/여러 조명/블렌딩/쉐이더 (요약)

- **삭제**: 패널 버튼 / 더블클릭(클릭 대상).
- **여러 조명**: 배열 관리, 선택 전환 가능.
- **블렌딩**: 선형 누적 + `u_blendStrength` 스케일, 톤매핑(노출) 후 sRGB.
- **쉐이더**: Size/Feather 분리, inverse-square falloff, 원/사각(회전 포함) 프로파일.

---

## 🎛️ 패널 구조(레이아웃 제안)

- **헤더(드래그 핸들)**: 제목/아이콘 · 도킹 상태 아이콘(좌/우) · 닫기/토글 버튼
- **섹션 1: 선택 상태**

  - 선택 라이트 ID/타입 표시(미선택 시 안내)
  - 삭제 버튼

- **섹션 2: 라이트 속성**

  - Size (px), Feather (px)
  - Intensity (0–2000), Color (팔레트)

- **섹션 3: 전역**

  - Blend Strength (0–2), Exposure (0.1–5)

- **풋터**

  - 힌트(단축키 `P` 토글, 더블클릭 삭제)

---

## 🧭 상태/저장 스펙

- **localStorage**

  - `panelPos: { x:number, y:number, snap:'left'|'right'|null }`
  - `panelVisible: boolean`
  - (선택) 마지막 모양 선택값, 전역 노출/블렌딩 값

- **윈도우 리사이즈/회전**

  - 복원 좌표 재클램프 → 가시 영역 보장

---

## ⚙️ 성능/안정성

- **드래그 스로틀**: rAF 단위(≈16ms) 위치 업데이트
- **포인터 캡처**: 드래그 시작 시 `setPointerCapture` 사용(크로스 브라우저 확인)
- **이벤트 충돌 방지**: 패널 루트에 `pointer-events: auto`, 캔버스는 기본. 패널 영역에서는 캔버스 이벤트가 **전파되지 않도록** 처리.
- **세이프 마진**: 상/하/좌/우 최소 8–16px 유지

---

## ✅ 통합 테스트 체크리스트

### 패널 오버레이/드래그

- [ ] 헤더만 드래그 가능, 본문 컨트롤 드래그 시 값만 변경
- [ ] 뷰포트 밖으로 이동 금지(클램프 OK)
- [ ] 좌/우 40px 내 스냅 → 도킹 표시 반영
- [ ] 새로고침 후 위치(스냅 상태 포함) 복원
- [ ] 패널 토글해도 **캔버스 크기/좌표 불변**

### 상호작용 충돌

- [ ] 패널 위 드래그 시 캔버스 이동/선택 반응 없음
- [ ] 패널 숨김 시 선택 **해제**되고, 다시 열어도 비선택 유지

### 조명/렌더링

- [ ] Size/Feather 독립 제어 결과가 셰이더에서 명확히 반영
- [ ] 다중 조명 Additive 합성 자연스러움(전역 블렌딩 강도 반응)
- [ ] HDR Intensity + Exposure 조합이 과도한 클리핑 없이 톤매핑

---
